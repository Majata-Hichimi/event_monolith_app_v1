<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Event Management UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <!-- Authentication Section -->
    <div
      id="auth-view"
      class="min-h-screen flex flex-col justify-center items-center p-6"
    >
      <div class="w-full max-w-sm bg-white p-6 rounded-2xl shadow-md">
        <h1 class="text-2xl font-bold text-center mb-6 text-blue-600">
          Event Management
        </h1>
        <div class="flex mb-4">
          <button
            id="login-tab"
            class="w-1/2 py-2 font-semibold border-b-2 border-blue-600"
          >
            Login
          </button>
          <button
            id="signup-tab"
            class="w-1/2 py-2 font-semibold border-b-2 border-transparent"
          >
            Sign Up
          </button>
        </div>

        <!-- Login Form -->
        <form id="login-form" class="space-y-4">
          <input
            type="email"
            id="login-email"
            placeholder="Email"
            required
            class="w-full px-3 py-2 border rounded-lg"
          />
          <input
            type="password"
            id="login-password"
            placeholder="Password"
            required
            class="w-full px-3 py-2 border rounded-lg"
          />
          <button
            type="submit"
            class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700"
          >
            Login
          </button>
          <p id="login-error" class="text-red-500 text-sm"></p>
        </form>

        <!-- Sign Up Form -->
        <form id="signup-form" class="space-y-4 hidden">
          <input
            type="email"
            id="signup-email"
            placeholder="Email"
            required
            class="w-full px-3 py-2 border rounded-lg"
          />
          <input
            type="password"
            id="signup-password"
            placeholder="Password"
            required
            class="w-full px-3 py-2 border rounded-lg"
          />
          <select id="signup-role" class="w-full px-3 py-2 border rounded-lg">
            <option value="ATTENDEE">Attendee</option>
            <option value="ORGANIZER">Organizer</option>
          </select>
          <button
            type="submit"
            class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700"
          >
            Sign Up
          </button>
          <p id="signup-error" class="text-red-500 text-sm"></p>
        </form>
      </div>
    </div>

    <!-- Main App Section -->
    <div id="main-view" class="hidden min-h-screen p-4">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-semibold text-blue-600">Events</h2>
        <button
          id="logout-btn"
          class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300"
        >
          Logout
        </button>
      </div>
      <div
        id="events-container"
        class="grid gap-4 md:grid-cols-2 lg:grid-cols-3"
      ></div>

      <!-- Create Event Button -->
      <button
        id="create-event-btn"
        class="hidden fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700"
      >
        +
      </button>
    </div>

    <!-- Create Event Modal -->
    <div
      id="create-event-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center"
    >
      <div class="bg-white p-6 rounded-2xl w-full max-w-md">
        <h3 class="text-xl font-semibold mb-4 text-blue-600">
          Create New Event
        </h3>
        <form id="create-event-form" class="space-y-3">
          <input
            type="text"
            id="event-title"
            placeholder="Event Title"
            required
            class="w-full px-3 py-2 border rounded-lg"
          />
          <input
            type="text"
            id="event-location"
            placeholder="Location"
            required
            class="w-full px-3 py-2 border rounded-lg"
          />
          <input
            type="date"
            id="event-date"
            required
            class="w-full px-3 py-2 border rounded-lg"
          />
          <textarea
            id="event-description"
            placeholder="Description"
            class="w-full px-3 py-2 border rounded-lg"
          ></textarea>
          <div class="flex justify-end gap-2">
            <button
              type="button"
              id="cancel-create"
              class="px-4 py-2 bg-gray-300 rounded-lg"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
            >
              Create
            </button>
          </div>
          <p id="create-event-error" class="text-red-500 text-sm"></p>
        </form>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:3000";
      let userToken = null;
      let userRole = null;
      let socket = null;

      // Element references
      const authView = document.getElementById("auth-view");
      const mainView = document.getElementById("main-view");
      const loginTab = document.getElementById("login-tab");
      const signupTab = document.getElementById("signup-tab");
      const loginForm = document.getElementById("login-form");
      const signupForm = document.getElementById("signup-form");
      const createBtn = document.getElementById("create-event-btn");
      const createModal = document.getElementById("create-event-modal");
      const createForm = document.getElementById("create-event-form");
      const cancelCreate = document.getElementById("cancel-create");
      const eventsContainer = document.getElementById("events-container");
      const logoutBtn = document.getElementById("logout-btn");

      // Tab switching
      loginTab.onclick = () => {
        loginTab.classList.add("border-blue-600");
        signupTab.classList.remove("border-blue-600");
        loginForm.classList.remove("hidden");
        signupForm.classList.add("hidden");
      };
      signupTab.onclick = () => {
        signupTab.classList.add("border-blue-600");
        loginTab.classList.remove("border-blue-600");
        signupForm.classList.remove("hidden");
        loginForm.classList.add("hidden");
      };

      // Authentication
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("login-email").value;
        const password = document.getElementById("login-password").value;
        const errorEl = document.getElementById("login-error");
        errorEl.textContent = "";

        try {
          const res = await fetch(`${API_BASE}/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Login failed");
          userToken = data.token;
          userRole = data.role;
          window.userToken = userToken;
          authView.classList.add("hidden");
          mainView.classList.remove("hidden");
          if (userRole === "ORGANIZER" || userRole === "ADMIN")
            createBtn.classList.remove("hidden");
          connectWebSocket();
          fetchEvents();
        } catch (err) {
          errorEl.textContent = err.message;
        }
      });

      signupForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("signup-email").value;
        const password = document.getElementById("signup-password").value;
        const role = document.getElementById("signup-role").value;
        const errorEl = document.getElementById("signup-error");
        errorEl.textContent = "";

        try {
          const res = await fetch(`${API_BASE}/signup`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password, role }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Signup failed");
          alert("Account created! You can now login.");
          signupTab.click();
        } catch (err) {
          errorEl.textContent = err.message;
        }
      });

      // Logout
      logoutBtn.onclick = () => {
        userToken = null;
        userRole = null;
        if (socket) socket.close();
        mainView.classList.add("hidden");
        authView.classList.remove("hidden");
      };

      // Fetch Events
      async function fetchEvents() {
        try {
          const res = await fetch(`${API_BASE}/events`, {
            headers: { Authorization: `Bearer ${userToken}` },
          });
          const events = await res.json();
          renderEvents(events);
        } catch (err) {
          console.error("Failed to fetch events", err);
        }
      }

      // Render Event Cards
      function renderEvents(events) {
        eventsContainer.innerHTML = "";
        events.forEach((evt) => {
          const card = document.createElement("div");
          card.className =
            "bg-white p-4 rounded-xl shadow hover:shadow-lg transition";
          card.innerHTML = `
          <h3 class="text-lg font-semibold text-blue-600">${evt.title}</h3>
          <p class="text-sm text-gray-600">${new Date(
            evt.date
          ).toLocaleString()}</p>
          <p class="text-sm">${evt.location}</p>
          <p class="text-sm mt-1">Status: ${
            evt.approved ? "✅ Approved" : "⏳ Pending"
          }</p>
          ${
            userRole === "ATTENDEE"
              ? `<button class="rsvp-btn mt-2 bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700" data-id="${evt.id}">RSVP</button>`
              : ""
          }
        `;
          eventsContainer.appendChild(card);
        });

        document.querySelectorAll(".rsvp-btn").forEach((btn) => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            try {
              await fetch(`${API_BASE}/events/${id}/rsvp`, {
                method: "POST",
                headers: { Authorization: `Bearer ${userToken}` },
              });
              fetchEvents();
            } catch {
              alert("RSVP failed");
            }
          };
        });
      }

      // Create Event
      createBtn.onclick = () => createModal.classList.remove("hidden");
      cancelCreate.onclick = () => createModal.classList.add("hidden");

      createForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const title = document.getElementById("event-title").value;
        const date = document.getElementById("event-date").value;
        const location = document.getElementById("event-location").value;
        const description = document.getElementById("event-description").value;
        const errorEl = document.getElementById("create-event-error");
        errorEl.textContent = "";

        try {
          const res = await fetch(`${API_BASE}/events`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${userToken}`,
            },
            body: JSON.stringify({ title, date, location, description }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Create failed");
          createModal.classList.add("hidden");
          createForm.reset();
          fetchEvents();
        } catch (err) {
          errorEl.textContent = err.message;
        }
      });

      // WebSocket Connection
      function connectWebSocket() {
        socket = new WebSocket("ws://localhost:3000/ws");
        socket.onopen = () => console.log("Connected to WS");
        socket.onmessage = (msg) => {
          console.log("WS update:", msg.data);
          fetchEvents();
        };
        socket.onclose = () => console.log("WS closed");
      }
    </script>
  </body>
</html>
